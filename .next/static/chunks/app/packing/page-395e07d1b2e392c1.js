(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[190],{3971:function(e,s,n){Promise.resolve().then(n.bind(n,7189))},7189:function(e,s,n){"use strict";let a;n.r(s),n.d(s,{default:function(){return y},dynamic:function(){return f},fetchCache:function(){return j}});var t=n(7437),l=n(2265);let r=e=>{let s;let n=new Set,a=(e,a)=>{let t="function"==typeof e?e(s):e;if(!Object.is(t,s)){let e=s;s=(null!=a?a:"object"!=typeof t||null===t)?t:Object.assign({},s,t),n.forEach(n=>n(s,e))}},t=()=>s,l={setState:a,getState:t,getInitialState:()=>r,subscribe:e=>(n.add(e),()=>n.delete(e))},r=s=e(a,t,l);return l},i=e=>e?r(e):r,c=e=>e,o=e=>{let s=i(e),n=e=>(function(e,s=c){let n=l.useSyncExternalStore(e.subscribe,l.useCallback(()=>s(e.getState()),[e,s]),l.useCallback(()=>s(e.getInitialState()),[e,s]));return l.useDebugValue(n),n})(s,e);return Object.assign(n,s),n},d=(a=(e,s)=>({header:null,lines:[],lastBoxNo:0,setHeader:s=>e({header:s}),addLine:(s,n)=>e(e=>{let a="number"==typeof n?n:e.lastBoxNo+1,t=Math.max(e.lastBoxNo,a);return{lines:[...e.lines,{box_no:a,...s}],lastBoxNo:t}}),deleteBox:s=>e(e=>{let n=e.lines.filter(e=>e.box_no!==s),a=0===n.length?0:Math.max(...n.map(e=>e.box_no));return{lines:n,lastBoxNo:a}}),clear:()=>e({header:null,lines:[],lastBoxNo:0})}))?o(a):o;var u=n(4873);function x(e){let{open:s,onClose:n,onAdded:a}=e,[r,i]=(0,l.useState)(""),[c,o]=(0,l.useState)(""),[d,x]=(0,l.useState)(!1);if(!s)return null;let p=async()=>{let e=r.trim().toUpperCase(),s=Number(c);if(e&&s){x(!0);try{let t=await (0,u.Z)("/api/catalogs/species-by-code/".concat(encodeURIComponent(e))),l={description_en:t.species.name_en,form:t.form.name,size:t.size.name,pounds:s};a(l),i(""),o(""),n()}catch(e){alert((null==e?void 0:e.message)||"Species not found")}finally{x(!1)}}};return(0,t.jsx)("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center",children:(0,t.jsxs)("div",{className:"bg-white rounded-xl p-4 w-[420px] space-y-3",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold",children:"Agregar Caja"}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{className:"text-sm",children:"Especie"}),(0,t.jsx)("input",{className:"border rounded px-2 py-1 w-full",placeholder:"e.g. BG5",value:r,onChange:e=>i(e.target.value)})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{className:"text-sm",children:"Pounds (int)"}),(0,t.jsx)("input",{className:"border rounded px-2 py-1 w-full",type:"number",value:c,onChange:e=>o(e.target.value)})]}),(0,t.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,t.jsx)("button",{className:"px-3 py-1 rounded border",onClick:n,children:"Cancel"}),(0,t.jsx)("button",{className:"px-3 py-1 rounded bg-black text-white disabled:opacity-50",onClick:p,disabled:d||!r.trim()||!c,children:"Add"})]})]})})}function p(e){let{open:s,onClose:n,onAdded:a}=e,[r,i]=(0,l.useState)(""),[c,o]=(0,l.useState)(""),[d,x]=(0,l.useState)(""),[p,m]=(0,l.useState)(""),[h,b]=(0,l.useState)(!1);if(!s)return null;let f=async()=>{let e=r.trim().toUpperCase(),s="string"==typeof c?NaN:c,t="string"==typeof d?NaN:d,l="string"==typeof p?NaN:p;if(e&&s&&t&&l&&!(t<s)){b(!0);try{let r=await (0,u.Z)("/api/catalogs/species-by-code/".concat(encodeURIComponent(e))),c={description_en:r.species.name_en,form:r.form.name,size:r.size.name,pounds:l},d=[];for(let e=s;e<=t;e++)d.push({...c});a(d),i(""),o(""),x(""),m(""),n()}catch(e){alert((null==e?void 0:e.message)||"Species not found")}finally{b(!1)}}};return(0,t.jsx)("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center",children:(0,t.jsxs)("div",{className:"bg-white rounded-xl p-4 w-[420px] space-y-3",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold",children:"Add range"}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("label",{children:"Species key"}),(0,t.jsx)("input",{className:"border rounded px-2 py-1 w-full",value:r,onChange:e=>i(e.target.value)})]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("label",{children:"From"}),(0,t.jsx)("input",{type:"number",className:"border rounded px-2 py-1 w-full",value:""===c?"":c,onChange:e=>o(""===e.target.value?"":parseInt(e.target.value,10))})]}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("label",{children:"To"}),(0,t.jsx)("input",{type:"number",className:"border rounded px-2 py-1 w-full",value:""===d?"":d,onChange:e=>x(""===e.target.value?"":parseInt(e.target.value,10))})]})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{children:"Pounds per box"}),(0,t.jsx)("input",{type:"number",className:"border rounded px-2 py-1 w-full",value:""===p?"":p,onChange:e=>m(""===e.target.value?"":parseInt(e.target.value,10))})]}),(0,t.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,t.jsx)("button",{className:"px-3 py-1 rounded border",onClick:n,children:"Cancel"}),(0,t.jsx)("button",{className:"px-3 py-1 rounded bg-black text-white",onClick:f,disabled:h,children:"Add"})]})]})})}function m(e){let{open:s,onClose:n,onAdded:a}=e,[r,i]=(0,l.useState)([{key:"",lbs:""}]),[c,o]=(0,l.useState)(!1);if(!s)return null;let d=(e,s,n)=>{i(a=>a.map((a,t)=>t===e?{...a,[s]:"lbs"===s?""===n?"":parseInt(n,10):n}:a))},x=e=>{i(s=>s.filter((s,n)=>n!==e))},p=async()=>{let e=r.filter(e=>""!==e.key.trim()&&""!==e.lbs&&Number(e.lbs)>0);if(0!==e.length){o(!0);try{let s=[];for(let n of e){let e=n.key.trim().toUpperCase(),a=Number(n.lbs),t=await (0,u.Z)("/api/catalogs/species-by-code/".concat(encodeURIComponent(e)));s.push({description_en:t.species.name_en,form:t.form.name,size:t.size.name,pounds:a})}a(s),i([{key:"",lbs:""}]),n()}catch(e){alert((null==e?void 0:e.message)||"Error resolving species code.")}finally{o(!1)}}};return(0,t.jsx)("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center",children:(0,t.jsxs)("div",{className:"bg-white rounded-xl p-4 w-[460px] space-y-3",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold",children:"Add combined box"}),(0,t.jsxs)("div",{className:"space-y-2",children:[r.map((e,s)=>(0,t.jsxs)("div",{className:"flex gap-2 items-end",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("label",{children:"Key"}),(0,t.jsx)("input",{className:"border rounded px-2 py-1 w-full",value:e.key,onChange:e=>d(s,"key",e.target.value)})]}),(0,t.jsxs)("div",{className:"w-28",children:[(0,t.jsx)("label",{children:"Lbs"}),(0,t.jsx)("input",{type:"number",className:"border rounded px-2 py-1 w-full",value:""===e.lbs?"":e.lbs,onChange:e=>d(s,"lbs",e.target.value)})]}),(0,t.jsx)("button",{onClick:()=>x(s),className:"border rounded px-2 h-8",children:"✕"})]},s)),(0,t.jsx)("button",{className:"text-sm underline",onClick:()=>{i(e=>[...e,{key:"",lbs:""}])},children:"+ Add line"})]}),(0,t.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,t.jsx)("button",{className:"px-3 py-1 border rounded",onClick:n,children:"Cancel"}),(0,t.jsx)("button",{className:"px-3 py-1 bg-black text-white rounded",onClick:p,disabled:c,children:"Save"})]})]})})}var h=n(8778);function b(e){let{open:s,onClose:n}=e,[a,r]=(0,l.useState)(!1),[i,c]=(0,l.useState)(null);(0,l.useEffect)(()=>{r(!0),c((0,h.c)())},[]);let{setHeader:o}=d(),[x,p]=(0,l.useState)(1),[m,b]=(0,l.useState)(""),[f,j]=(0,l.useState)(""),[g,y]=(0,l.useState)(null),[N,v]=(0,l.useState)(new Date().toISOString().slice(0,10)),[w,C]=(0,l.useState)("");if(!a||!s||!i)return null;let k=async()=>{let e=m.trim().toUpperCase();if(e){if((await (0,u.Z)("/api/invoices/check?no=".concat(encodeURIComponent(e)))).exists){if("proceso"===i){confirm("Invoice ".concat(e," ya existe.\n\xbfAbrir en edici\xf3n?"))&&(window.location.href="/packing/".concat(e,"/edit"));return}if("facturacion"===i){window.location.href="/packing/".concat(e,"/view");return}let s=prompt("Invoice ".concat(e," ya existe.\nOpciones: view, edit, pricing, export"),"view");if(!s)return;let n=s.toLowerCase();"view"===n&&(window.location.href="/packing/".concat(e,"/view")),"edit"===n&&(window.location.href="/packing/".concat(e,"/edit")),"pricing"===n&&(window.location.href="/packing/".concat(e,"/pricing")),"export"===n&&(window.location.href="/api/export/excel?invoice=".concat(e));return}p(2)}},S=async()=>{let e=f.trim().toUpperCase();if(e)try{let s=await (0,u.Z)("/api/catalogs/client/".concat(encodeURIComponent(e)));y(s),p(3)}catch(a){if(!h.B.startPacking(i)){alert("Cliente no existe y tu rol no puede crearlo.");return}if(!confirm("Cliente ".concat(e," no existe.\n\xbfCrear ahora?")))return;let s=prompt("Nombre del cliente:");if(!s)return;let n={code:e,name:s,address:prompt("Direcci\xf3n:")||"",city:prompt("Ciudad:")||"",state:prompt("Estado:")||"",country:prompt("Pa\xeds:")||"USA",zip:prompt("ZIP:")||"",tax_id:prompt("Tax ID:")||""};y((await (0,u.Z)("/api/catalogs/new-client",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).client),p(3)}};return(0,t.jsx)("div",{className:"fixed inset-0 bg-black/40 z-50 flex items-center justify-center",children:(0,t.jsxs)("div",{className:"bg-white p-5 rounded-xl w-full max-w-md space-y-5",children:[(0,t.jsx)("h2",{className:"text-xl font-bold",children:"Nuevo Packing"}),1===x&&(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("label",{children:"Factura / Invoice"}),(0,t.jsx)("input",{className:"border rounded px-3 py-2 w-full",value:m,onChange:e=>b(e.target.value),onKeyDown:e=>"Enter"===e.key&&k()}),(0,t.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,t.jsx)("button",{className:"border px-3 py-1 rounded",onClick:n,children:"Cancelar"}),(0,t.jsx)("button",{className:"px-3 py-1 bg-black text-white rounded",onClick:k,children:"Continuar"})]})]}),2===x&&(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("label",{children:"Cliente / C\xf3digo"}),(0,t.jsx)("input",{className:"border rounded px-3 py-2 w-full",value:f,onChange:e=>j(e.target.value),onKeyDown:e=>"Enter"===e.key&&S()}),(0,t.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,t.jsx)("button",{className:"border px-3 py-1 rounded",onClick:()=>p(1),children:"Atr\xe1s"}),(0,t.jsx)("button",{className:"px-3 py-1 bg-black text-white rounded",onClick:S,children:"Resolver"})]})]}),3===x&&g&&(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsxs)("div",{className:"text-sm",children:[(0,t.jsx)("b",{children:g.name}),(0,t.jsx)("br",{}),g.address,(0,t.jsx)("br",{}),"TAX: ",g.tax_id]}),(0,t.jsx)("label",{children:"Fecha"}),(0,t.jsx)("input",{type:"date",className:"border rounded px-3 py-2 w-full",value:N,onChange:e=>v(e.target.value)}),(0,t.jsx)("label",{children:"AWB / Gu\xeda"}),(0,t.jsx)("input",{className:"border rounded px-3 py-2 w-full",value:w,onChange:e=>C(e.target.value)}),(0,t.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,t.jsx)("button",{className:"border px-3 py-1 rounded",onClick:()=>p(2),children:"Atr\xe1s"}),(0,t.jsx)("button",{className:"px-3 py-1 bg-green-600 text-white rounded",onClick:()=>{g&&(o({client_code:g.code,client_name:g.name,address:g.address,tax_id:g.tax_id,guide:w,invoice_no:m.trim().toUpperCase(),date:N}),n(),alert("Packing iniciado → ahora agrega cajas."))},children:"Iniciar Packing"})]})]})]})})}let f="force-dynamic",j="force-no-store";function g(e){return e.length?e.reduce((e,s)=>s.box_no>e?s.box_no:e,e[0].box_no)+1:1}function y(){var e,s,n,a;let{header:r,setHeader:i,lines:c,addLine:o,deleteBox:h,clear:f}=d(),[j,y]=(0,l.useState)(!r),[N,v]=(0,l.useState)(!1),[w,C]=(0,l.useState)(!1),[k,S]=(0,l.useState)(!1),[_,I]=(0,l.useState)(!1),[A,O]=(0,l.useState)(null!==(e=null==r?void 0:r.client_code)&&void 0!==e?e:""),[E,B]=(0,l.useState)(null!==(s=null==r?void 0:r.guide)&&void 0!==s?s:""),[P,T]=(0,l.useState)(null!==(n=null==r?void 0:r.invoice_no)&&void 0!==n?n:""),[U,z]=(0,l.useState)(null!==(a=null==r?void 0:r.date)&&void 0!==a?a:new Date().toISOString().slice(0,10)),[Z,L]=(0,l.useState)(null),R=async()=>{let e=A.trim().toUpperCase();if(e)try{let s=await (0,u.Z)("/api/catalogs/client/".concat(encodeURIComponent(e))),n={client_code:e,client_name:s.name,address:s.address,tax_id:s.tax_id,guide:E,invoice_no:P,date:U};i(n)}catch(e){alert("Cliente no encontrado.")}},D=[...c].sort((e,s)=>e.box_no-s.box_no||e.description_en.localeCompare(s.description_en)),F=new Set(c.map(e=>e.box_no)).size,G=c.reduce((e,s)=>e+s.pounds,0);return(0,t.jsx)("main",{className:"w-full flex justify-center",children:(0,t.jsxs)("div",{className:"w-full max-w-4xl p-6 space-y-6",children:[(0,t.jsx)(b,{open:j,onClose:()=>y(!1)}),!r&&!j&&(0,t.jsx)("div",{className:"text-center mt-10 text-gray-500",children:"Iniciando packing..."}),r&&!j&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("h1",{className:"text-3xl font-bold text-center",children:"Ingreso de Packing"}),(0,t.jsx)("section",{className:"border rounded-xl p-4 space-y-4 bg-white shadow-sm",children:(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)("label",{className:"text-sm",children:"Cliente:"}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)("input",{className:"border rounded px-2 py-1 w-full",value:A,onChange:e=>O(e.target.value),placeholder:"HE, SL, ..."}),(0,t.jsx)("button",{className:"px-3 py-1 rounded bg-black text-white",onClick:R,children:"Ok"})]}),(0,t.jsxs)("div",{className:"text-sm mt-1",children:[(0,t.jsx)("b",{children:r.client_name}),(0,t.jsx)("div",{children:r.address}),(0,t.jsxs)("div",{children:["TAX: ",r.tax_id]})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"text-sm",children:"AWB:"}),(0,t.jsx)("input",{className:"border rounded px-2 py-1 w-full",value:E,onChange:e=>B(e.target.value)})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"text-sm",children:"Factura #:"}),(0,t.jsx)("input",{className:"border rounded px-2 py-1 w-full",value:P,onChange:e=>T(e.target.value)})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"text-sm",children:"Fecha:"}),(0,t.jsx)("input",{type:"date",className:"border rounded px-2 py-1 w-full",value:U,onChange:e=>z(e.target.value)})]})]})]})}),(0,t.jsxs)("section",{className:"flex gap-2",children:[(0,t.jsx)("button",{className:"px-3 py-1 rounded bg-black text-white",onClick:()=>v(!0),children:"+ Simple"}),(0,t.jsx)("button",{className:"px-3 py-1 rounded border",onClick:()=>C(!0),children:"+ Rango"}),(0,t.jsx)("button",{className:"px-3 py-1 rounded border",onClick:()=>S(!0),children:"+ Combinada"}),(0,t.jsx)("button",{className:"px-3 py-1 rounded bg-green-600 text-white ml-auto",onClick:async()=>{if(confirm("\xbfGuardar packing?"))try{await (0,u.Z)("/api/packing/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"final",packing:{invoice_no:P,header:r,lines:c}})}),alert("Packing guardado."),f(),window.location.href="/packing"}catch(e){alert(e.message||"Error al guardar.")}},children:"Guardar"})]}),(0,t.jsx)("section",{className:"overflow-x-auto",children:(0,t.jsxs)("table",{className:"min-w-full border rounded bg-white shadow-sm",children:[(0,t.jsx)("thead",{className:"bg-gray-100",children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{className:"p-2 border",children:"Box"}),(0,t.jsx)("th",{className:"p-2 border",children:"Item"}),(0,t.jsx)("th",{className:"p-2 border",children:"FORM"}),(0,t.jsx)("th",{className:"p-2 border",children:"Size"}),(0,t.jsx)("th",{className:"p-2 border text-right",children:"Lbs"})]})}),(0,t.jsx)("tbody",{children:D.map((e,s)=>{let n=D[s-1],a=n&&n.box_no===e.box_no;return(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{className:"p-2 border",children:a?"MX":e.box_no}),(0,t.jsx)("td",{className:"p-2 border",children:e.description_en}),(0,t.jsx)("td",{className:"p-2 border",children:e.form}),(0,t.jsx)("td",{className:"p-2 border",children:e.size}),(0,t.jsx)("td",{className:"p-2 border text-right",children:e.pounds})]},s)})}),(0,t.jsxs)("tfoot",{children:[(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{className:"p-2 border font-semibold",children:"TOTAL BOXES"}),(0,t.jsx)("td",{className:"p-2 border",colSpan:3}),(0,t.jsx)("td",{className:"p-2 border text-right font-semibold",children:F})]}),(0,t.jsxs)("tr",{children:[(0,t.jsx)("td",{className:"p-2 border font-semibold",children:"TOTAL LBS"}),(0,t.jsx)("td",{className:"p-2 border",colSpan:3}),(0,t.jsx)("td",{className:"p-2 border text-right font-semibold",children:G})]})]})]})}),(0,t.jsx)(x,{open:N,onClose:()=>v(!1),onAdded:e=>{o(e,g(c))}}),(0,t.jsx)(p,{open:w,onClose:()=>C(!1),onAdded:e=>{let s=g(c);e.forEach((e,n)=>o(e,s+n))}}),(0,t.jsx)(m,{open:k,onClose:()=>S(!1),onAdded:e=>{if(!e.length)return;let s=g(c);e.forEach(e=>o(e,s))}}),(0,t.jsx)(m,{open:_,onClose:()=>I(!1),onAdded:e=>{Z&&(h(Z),e.forEach(e=>o(e,Z)))}})]})]})})}},4873:function(e,s,n){"use strict";async function a(e,s){let n=await fetch(e,{credentials:"same-origin",...s});if(!n.ok){let e="";try{e=await n.text()}catch(e){}throw Error(e||"HTTP ".concat(n.status))}return n.json()}n.d(s,{Z:function(){return a}})},8778:function(e,s,n){"use strict";function a(){let e=document.cookie.split("; ").find(e=>e.startsWith("qp_session="));if(!e)return null;try{let s=e.split("=")[1],n=JSON.parse(atob(s)),a=(n.role||n.rol||"").toLowerCase();if("proceso"===a||"facturacion"===a||"admin"===a)return a;return null}catch(e){return null}}n.d(s,{B:function(){return t},c:function(){return a}});let t={startPacking:e=>"proceso"===e||"admin"===e,addBoxes:e=>"proceso"===e||"admin"===e,editBoxes:e=>"proceso"===e||"admin"===e,finalize:e=>"proceso"===e||"admin"===e,pricing:e=>"admin"===e,exportAny:e=>"admin"===e,viewOnly:e=>"facturacion"===e}}},function(e){e.O(0,[971,23,744],function(){return e(e.s=3971)}),_N_E=e.O()}]);